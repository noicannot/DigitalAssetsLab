- [零知识证明](#零知识证明)
  - [定义](#定义)
  - [**零知识证明的源头**](#零知识证明的源头)
  - [三个性质](#三个性质)
  - [零知识证明的核心价值：消灭可信第三方。](#零知识证明的核心价值消灭可信第三方)
  - [举例](#举例)
  - [零知识证明是零信任吗](#零知识证明是零信任吗)
  - [零知识证明分类](#零知识证明分类)
  - [零知识证明原理](#零知识证明原理)
  - [零知识证明应用场景](#零知识证明应用场景)
    - [在区块链数字货币中的应用](#在区块链数字货币中的应用)
      - [Zcash](#zcash)
      - [Monero](#monero)
    - [在区块链其他场景中的应用——以太坊扩容](#在区块链其他场景中的应用以太坊扩容)
    - [在安全多方计算中的应用](#在安全多方计算中的应用)
# 零知识证明

## 定义

零知识证明(Zero—Knowledge Proof)，是由S.Goldwasser、S.Micali及C.Rackoff在20世纪80年代初提出的。它指的是证明者能够在不向验证者提供任何有用的信息的情况下，使验证者相信某个论断是正确的。

简单的说，就是你向我陈述一件事情，虽然我听不懂你在说什么，但我可以判断这事情的真假。

举个例子，假设A是色盲，A想知道B是不是色盲，但问题是A本身都分不清红绿，如何判断B能否分清呢？方法可以是这样：A一手拿红球、一手拿绿球，给B看并请他指出那颗是红球，然后A把两手放到背后交换(或不交换)，再拿给B看也请他再指出那颗是红球，这样的过程重覆100次，如果B每次都能指出同一颗球(只有A知道有没有在背后作两颗球的交换)，就可以大概率判定B不是色盲，而即便到最后，A还是无法判断红绿(零知识).

零知识证明(Zero—Knowledge Proof)起源于最小泄露证明。设P表示掌握某些信息，并希望证实这一事实的实体，设V是证明这一事实的实体。假如某个协议向V证明P的确掌握某些信息，但V无法推断出这些信息是什么，我们称P实现了最小泄露证明。不仅如此，如果V除了知道P能够证明某一事实外，不能够得到其他任何知识，我们称P实现了零知识证明，相应的协议称作零知识协议。

零知识证明解决了信任与隐私的矛盾：既通过「证明」提升「信任」，又通过「零知识」保护「隐私」。是两全其美的方案。

## **零知识证明的源头**

零知识证明是1984年由Goldwasser、Micali、Rackoff三个人提出，论文题目是《The Knowledge Complextiy of Interactive Proof Systems》（《交互式证明系统中的知识复杂性》）。

## 三个性质

**完备性**（Completeness）

只要证明者拥有相应的知识，那么就能通过验证者的验证，即证明者有足够大的概率使验证者确信。
P无法欺骗V。换言之，若P不知道一个定理的证明方法，则P使V相信他会证明定理的概率很低。

**可靠性**（Soundness）

如果证明者没有相应的知识，则无法通过验证者的验证，即证明者欺骗验证者的概率可以忽略。
V无法欺骗P。若P知道一个定理的证明方法，则P使V以绝对优势的概率相信他能证明。

**零知识性**（Zero-Knowledge）

证明者在交互过程中仅向验证者透露是否拥有相应知识的陈述，**不会泄露任何关于知识的额外信息**。
V无法获取任何额外的知识。


我们把性质(1)和(2)称为零知识证明的正确性和完备性，而性质(3)称为零知识性。

## 零知识证明的核心价值：消灭可信第三方。

当互联⽹电⼦商务和在线交易蓬勃发展到今天，可信第三方（TTP，Trusted Third Party）几乎不可或缺。但大家体会不到的事实是，可信第三方引入了巨大的「信任成本」。对第三方的过度信任，会带来严重的「隐私泄露」、「单点失效」、「个⼈信息滥⽤」等问题。

我们可以从另⼀个⻆度来理解中本聪的创新：比特币实现了⼀种分布式协议，它以去中心化的方式，「模拟」出了一个「虚拟」的「可信第三⽅」。

而对于零知识证明也可以这样理解：零知识证明实现了一类密码学理论技术，它基于一些安全假设，「模拟」出了⼀个虚拟的可信第三方。

可见，「零知识证明」的一个重要作用是消灭可信第三方。换句话说，零知识证明提供的「信任」，能够代替一个「可信第三方」。

需要注意的是：「零知识证明」取代的并非是「第三方」，而是「可信第三方」。

球的例子中的零知识证明，是一种**基于概率的验证方式（即概率证明，而非确定性证明）**，验证者（verifier）基于一定的随机性向证明者（prover)提出问题，如果证明者都能给出正确回答，则说明证明者大概率拥有他所声称的“知识”。

看看这个示例是如何满足零知识证明的定义中的**三性**：

**完备性**

如果Bob拥有分辨球颜色的知识，则Bob每次都会正确回答。

**可靠性**

如果Bob不具备分辨球颜色的知识，则Bob无法总是回答正确。

**零知识性**

直到最后，Alice也无法得知两球的具体颜色，因为Bob从未透露这个信息。

零知识证明并不是数学意义上的证明，因为它存在小概率的误差，欺骗者有可能通过虚假陈述骗过证明者。换句话来说，零知识证明是概率证明而不是确定性证明。但是也存在有技术能将误差降低到可以忽略的值。

零知识的形式定义必须使用一些计算模型，最常见的是图灵机的计算模型。

## 举例

1、A要向B证明自己拥有某个房间的钥匙，假设该房间只能用钥匙打开锁，而其他任何方法都打不开。这时有2个方法：

①A把钥匙出示给B，B用这把钥匙打开该房间的锁，从而证明A拥有该房间的正确的钥匙。

②B确定该房间内有某一物体，A用自己拥有的钥匙打开该房间的门，然后把物体拿出来出示给B，从而证明自己确实拥有该房间的钥匙。

后面的②方法属于零知识证明。它的好处在于，在整个证明的过程中，B始终不能看到钥匙的样子，从而避免了钥匙的泄露。

2、A拥有B的公钥，A没有见过B，而B见过A的照片，偶然一天两个人见面了，B认出了A，但A不能确定面前的人是否是B，这时B要向A证明自己是B，也有2个方法。

① B把自己的私钥给A，A用公钥对某个数据加密，然后用B的私钥解密，如果正确，则证明对方确实是B。

② A给出一个随机值，并使用B的公钥对其加密，然后将加密后的数据交给B，B用自己的私钥解密并展示给A，如果与A给出的随机值相同，则证明对方是B。

后面的方法属于零知识证明。

## 零知识证明是零信任吗

零知识证明和零信任这两个词，都带有“零”，都与“信任”有关，但并不是一回事。两者本质上都要增强「信任」，但在增强「信任」的过程中，零知识证明强调不泄露知识；零信任强调不要过度授权。简单说，零知识是为了隐藏知识；零信任是为了控制信任。

## 零知识证明分类

到目前为止，具有应用前景的零知识证明工具可以分类两类：

- 一类证明慢、验证快、证明体积小
- 另一类证明快、验证快、证明体积小大

第一类由于验证快，不占用空间的特点，很快得到区块链开发者的青睐，同时随着ZCash的迅速传播，其使用的zk-SNARKs协议也越来越受关注。

第二类证明快的特点使得其在移动设备，嵌入式设备的部署成为可能，而隔离见证等技术有望缓解其证明体积较大的问题，在区块链领域的也是前途无量。

零知识证明可以分为「交互式」和「非交互式」两种。接下来我们就一一来看看这两种证明方式有哪些不同。

* 交互式零知识证明

零知识证明协议的基础是交互式的。它要求验证者不断对证明者所拥有的“知识”进行一系列提问。例如，如果有人声称自己知道数独游戏的答案，零知识证明的过程就是验证者需要随机指定要通过列、行或九个正方形进行验证。每轮测试不需要知道具体的答案，只需要检测数字1~9是否包含在内。只要验证的次数足够多，就有理由相信证明者是知道数独问题答案的。

然而，这种简单的方法并不能使人相信证明者和验证者都是真实的。在数独这种情况下，两者可以提前串通，以便证明者可以在不知道答案的情况下依然通过验证。如果他们想要说服第三方，验证者还必须要证明验证过程是随机的，并且他不会向证明者泄漏答案。因此，第三方难以验证交互式零知识证明的结果，要向多人证明某些东西的话则需要额外的努力和成本才行。

* 非交互式零知识证明

顾名思义，非交互式零知识证明不需要交互过程，避免了串通的可能性，但是可能需要额外的机器和程序来确定实验的顺序。例如，在数独这个例子中，由程序决定要验证的列或行。验证序列必须保密，否则验证者可能会在不知道真正“知识”的情况下通过验证。

## 零知识证明原理

零知识证明原理大体由以下组成：

* 多项式问题的转化 - 需要证明的问题转化为多项式问题 t (x) h (x) = w (x) v (x)，证明者提交证明让验证者确认多项式成立。

* 随机挑选验证 - 随机选择验证的数值 s，验证 t (s) h (s) = w (s) v (s)。相对于验证多项式相等 t (x) h (x) = w (x) v (x)，随机挑选验证，简单，验证数据少。随机挑选验证，安全性肯定不及多项式等式验证，但如果确实足够随机，安全性还是相当高的。

* 同态隐藏 - 同态隐藏指的是函数的一种特性。输入的计算和输出的计算保持 “同态”。以加法同态为例，满足如下的三个条件的函数 E (x)，称为加法同态：1. 给定 E (x)，很难推导出 x. 2. 不同的输入，对应不同输出 3. E (x+y) 可以由 E (x)，E (y) 计算出来。乘法同态类似。

## 零知识证明应用场景

作为一类经典的密码学原语，零知识证明至今已有三十多年的历史。但是，直至近年来基于区块链的匿名数字货币的诞生，零知识证明技术才开始有了较大规模的应用。目前，零知识证明在工程应用上仍处于起步阶段，且在可信设置、运算效率等方面存在着一些瓶颈，依然还是一项尚未真正成熟的密码学技术。

本章对目前零知识证明技术在区块链、数字货币、安全多方计算等领域的应用场景进行举例分析。

### 在区块链数字货币中的应用

#### Zcash

ZCash可能是成功实现零知识证明的最著名的区块链项目之一。Zcash实现了ZKP的修改版本，被称为zk-SNARKS，代表Zero-Knowledge Succinct Non-Interactive Argument of Knowledge（零知识简明非交互式知识证明）

zk-SNARK技术减少了证明的大小以及验证所需的计算量。它能够在不泄漏有关地址和相关有价值的任何关键信息的情况下证明有效交易条件得到了满足。

zk-SNARK将需要验证的交易内容转换为两个多项式乘积相等的证明，并结合同态加密和其他先进技术，在执行交易验证时保护隐藏的交易金额。

其过程可以简单地描述为：

* 将代码拆分为可验证的逻辑验证步骤，然后将这些步骤拆分为一个由加法、减法、乘法和除法组成的运算电路；

* 进行一系列变换，将待验证的代码转化为多项式方程，如t(x)h(x)= w(x)v(x)；

* 为了使证明更加简洁，验证者预先随机选择几个检查点s 来检查这些点的方程是否为真；

* 通过同态编码/加密，验证者在计算方程式时不知道实际输入值，但仍然可以进行验证；

* 在方程的左边和右边，同时乘以一个不等于0的秘密值k。当验证(t(s)h(s)k) 等于(w(s)v(s)k)时，具体的t(s)、 h(s)、 w(s)和v(s) 是不可知的，从而达到保护信息的目的。

但zk-SNARK并不是完美的。当前zk-SNARK实现中的一个缺陷，是需要提前设置参数。如果这些参数被泄漏，那么整个网络将面临毁灭性的打击。因此，在使用这些网络时，用户必须坚信参数不会被泄漏。
Zcash是一种基于区块链的匿名数字货币，起源于Zerocoin协议。2014年，经过效率和匿名性等方面的改进，Zerocoin协议发展为Zerocash协议。2016年，基于Zerocash协议的Zcash数字货币应用项目正式向公众开放。

Zcash采用zk-SNARK零知识证明协议实现了隐蔽交易的功能。在比特币中，需要通过公开在区块链上的交易发送方地址、交易接收方地址以及输入和输出金额来验证交易。而在Zcash中，通过zk-SNARK来证明交易满足有效条件，而不会公开任何有关地址或金额的关键信息。隐蔽交易的发送方通过构建一个证明，从而以足够高的概率来证明交易满足以下条件：

* 交易的输入总金额和输出总金额相等；

* 交易发送方拥有支配交易金额的私钥；

* 支配交易金额的私钥与交易的签名绑定，交易无法被不知道私钥的人篡改。

在Zcash中，隐蔽交易的UTXO（Unspent Transaction Output）被称为Commitment（承诺），而支出一个Commitment对应的金额需要公布一个相应的Nullifier。Zcash节点会保存包含所有已创建的Commitment组成的Merkle树以及所有已公布的Nullifier列表。Commitment和Nullifier通过哈希值存储，防止泄露Commitment的信息以及Commitment和Nullfier的对应关系。

对于输入金额的来源，每次隐蔽交易都会产生一份未使用的金额，以一个Commitment的形式进行公布，其值为接收方地址、交易金额、秘密的交易唯一标识和一个随机串（Random Nounce）的哈希值。

对于输出金额的去向，当隐蔽交易发起时，交易发送方使用支配交易金额的私钥发布一个Nullifier，其值是现有未使用Commitment中交易唯一标识的哈希值，并生成证明其有权使用相应金额的零知识证明。交易发送方需要将私钥对应的公钥和交易唯一标识通过秘密信道发送给交易接收方以完成交易。为了防止双花，Zcash区块链节点会验证该Nullifier不在已经公布的列表中。

进而，隐蔽交易的零知识证明还可以验证以下论断的真实性：

* 对于每一份输入金额，都存在一个已公布的Commitment；

* Nullifier和Commitment是被正确计算的；

* 不同输出交易的Nullifier不会发生哈希碰撞。

对于每个隐蔽交易，交易发送方通过证明密钥生成输入金额有效性证明，区块链节点通过验证密钥来验证交易发送方的证明。

Zcash通过Trusted Setup公共参数仪式生成零知识证明的证明密钥和验证密钥，并与Zcash网络中的所有参与者共享。2016年10月22日至23日，Zcash举行了可信设置仪式生成zk-SNARK的公共参考串CRS，通过由具有竞争关系的六个参与者参与的多方计算协议，保证CRS的安全生成，除非参与参数生成的所有人共谋，否则被销毁的随机参数无法得到恢复。

#### Monero

Monero（门罗币）也是一种支持交易隐私保护的数字货币，创始于2014年，其通过密码学技术手段实现了以下两个属性：

* 不可链接性（Unlinkability）：无法判断两个交易的接收方是否是同一个人，即保证了交易接收方的匿名性；

* 不可追踪性（Untraceability）：无法知道交易的发送方是谁，即保证了交易发送方的匿名性。

Monero主要依赖于以下三种密码学机制：

 * 一次性密钥（One-Time Key）：每次交易生成不同密钥以隐藏真实的交易接收方；

* 环签名（Ring Signature）：将交易发送方的输入与其他人的输入进行混淆签名，外界无法将不同交易进行关联；

* 环签名保密交易（Ring Confidential Transaction, RingCT）：隐藏交易金额。

RingCT采用零知识证明技术——Pedersen承诺，可在隐藏交易金额的同时实现区块链的验证，即对交易的输入总金额与输出总金额（包含交易费用）之差是否为0进行零知识证明承诺。

然而，由于基于群代数的密码学存在模运算，无法将小负数与对应模数的大正数进行区分，可能导致伪造币的产生。因此，为了在保护交易金额机密性的同时保证交易金额不为负数，且金额不能过大至与小负数在对应模数上同余，需要对交易的输出金额进行范围证明。最初的范围证明协议基于Borromean环签名技术，其证明大小与范围区间的上限成线性关系，成为了交易的主要负担，影响了区块链的整体效率。

2018年，Monero进行了一次硬分叉升级，引入了BulletProof零知识证明算法以提升交易效率。BulletProof用于取代之前基于环签名的范围证明协议，其产生的证明大小仅与范围区间上限成对数关系，同时可将多个证明进行合并以实现进一步优化，最终将区块链的大小以及交易费用减少70%~80%。

### 在区块链其他场景中的应用——以太坊扩容

以太坊（Ethereum）是一个知名的公有区块链平台，通过在去中心化网络节点上的以太坊虚拟机（Ethereum Virtual Machine, EVM）中运行以图灵完备语言编写的智能合约（Smart Contract），进而承载去中心化应用（Decentrialized Application, DApp）的部署。随着越来越多DApp的部署，以太坊遇到了几乎所有公有链平台所共有的性能瓶颈问题，由此产生了各类针对以太坊的扩容方案。

以太坊扩容方案一般分为第一层（Layer-1）扩容方案和第二层（Layer-2）扩容方案。Layer-1扩容方案是指直接增加链上的交易处理能力，即链上扩容，常见的技术方案有分片（Sharding）和有向无环图（Directed Acyclic Graph, DAG）等；Layer-2扩容方案是指将链上的相当一部分工作量转移到链下完成，常见的技术方案包括状态通道、Plasma、Truebit等。

ZK-Rollup是一类基于zk-SNARK零知识证明的以太坊Layer-2扩容方案，其实现案例为ZK-Sync去信任化扩容及隐私解决方案。ZK-Rollup将链上的账户状态（包含公钥、Nonce和余额）压缩存储在一棵Merkle树中，并将账户状态变更的处理转移到链下，同时通过zk-SNARK零知识证明生成每个交易的有效性证明，保证链下账户状态变更的正确性，具体包括交易的Nonce、金额、费用以及签名等内容的正确性，并将证明结果提交到链上的智能合约中。由于在链上直接处理账户状态变更的成本较高，而仅通过链上的智能合约验证零知识证明结果的成本相对低很多，因此零知识证明的应用可大大提高以太坊的交易处理效率，真正实现扩容的目的。零知识证明技术的引入预计可将以太坊的每秒交易吞吐量从目前的约15TPS提升至主流支付转接清算网络级别的数千TPS。

值得一提的是，以太坊的创始人Vitalik Buterin本人就是一个零知识证明技术的支持者，曾多次在不同场合公开支持zk-SNARK等零知识证明技术在以太坊等区块链平台中进行应用。

### 在安全多方计算中的应用

隐私计算是密码学技术的另一个重要应用领域。基于密码学的安全多方计算（Multi-Party Computation, MPC）方案通常采用混淆电路（Garbled Circuit）、不经意传输（Oblivious Transfer）、同态加密（Homomorphic Encryption）、同态承诺（Homomorphic Commitment）、秘密共享（Secret Sharing）以及零知识证明等技术手段，实现多个参与方之间数据共享计算过程中的隐私保护。从密码学的本质上来说，安全多方计算的定义是在无可信第三方的情况下，若干个互相不信任的参与方使用各自的私有数据安全地计算一个约定函数而不泄露各自原始数据的问题。

在典型的安全多方计算方案中，参与方之间通常会事先约定一个计算框架，并要求双方按照既定的框架执行计算。但是，参与方可能怀疑对方是否使用其私有数据真正进行了计算，因此可引入零知识证明技术用于解决这一计算结果的可信验证问题。具体而言，参与方中的一方在通过混淆电路或同态加密等方法完成安全计算后，除了将计算结果提供给其他参与方外，还可将计算过程转化为零知识证明电路，并采用零知识证明算法生成计算过程的证明结果供其他参与方验证。根据零知识证明协议满足的完备性、可靠性和零知识性三个基本属性，通过这一过程即可在不泄露具体计算数据的情况下，使其他参与方相信计算是按照正确步骤进行的。