[toc]

---

##  两阶段提交(2PC)

---

> 分布式事务的基本理论：基本遵循CPA理论，采用柔性事务特征，软状态或者最终一致性特点来保证最终一致性问题。

### 一，两阶段提交(2PC)

> 是一个非常经典的 **强一致性，中心化的原子提交协议**

> 一个中心化的协调者节点，N个参与者节点组成。

> 两个阶段：一个是投票阶段，提交/执行阶段。

#### 第一个阶段分为三步：

第一步，**协调者**向所有的**参与者**发送事务预处理请求，并开始等待**参与者**的响应。

第二步，各个**参与者**执行本地事务操作，执行完成之后并不会提交本地的数据库事务。先向**协调者**报告是否可以执行本次的事务。

第三步，**协调者**收到各个**参与者**的本地执行事务的状态，一般也就两类情况，1，全部yes。2，部分或是全部no。

![](https://img2018.cnblogs.com/blog/1090617/201907/1090617-20190710222443794-591603727.jpg)

#### 第二阶段（正常情况)

第一步， **协调者** 向 **所有参与者** 节点发出Commit请求。

第二步，**参与者** 收到Commit请求之后,就会正式执行本地事务Commit操作,并在完成提交之后释放整个事务执行期间占用的事务资源

#### 第二阶段（异常情况）

第一步，**协调者** 向所有参与者节点发出 **RoollBack** 请求。

第二步，**参与者** 接收到RoollBack请求后,会回滚本地事务。

### 二，2PC的缺点

缺陷：

- 性能问题，无论第一阶段的过程中还是第二阶段过程中所有参与者资源都是被锁住的。只有所有的节点都准备完毕，事务协调者才发起全局提交。过程比较长，对性能影响比较大。
- 单节点故障，由于协调者非常重要，一旦协调者发生故障。参会者会一直阻塞下去。尤其是在第二阶段。虽然协调者挂掉可以重新选择一个，但是无法解决协调者宕机导致的参与者处于阻塞状态的问题。

### 三，总结

> 重点是第二阶段，虽然只有两步，但是发生问题之后，不太好解决，因为参与者状态容易不一致。单点故障发生的概率还是比较常见的。