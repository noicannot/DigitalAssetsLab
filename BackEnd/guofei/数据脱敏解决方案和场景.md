## 使用背景

- 在实际的业务场景中，业务开发团队需要针对公司安全部门需求，针对涉及客户安全数据或者一些商业性敏感数据，如身份证号、手机号、银行卡号、客户号等个人信息，都需要进行数据脱敏

## 存在的痛点

- **痛点一**：通常的解决方案是书写 SQL 的时候，把对应的加密字段手动进行加密再进行插入，在查询的时候使用之前在手动进行解密。虽然可行，但是非常繁琐，日常业务开发与加密细节耦合性太高，也就是代码侵入性较大
- **痛点二**：对于一些为了快速上线而一开始没有实现合规脱敏的系统，如何才能快速的使得已有业务满足合规要求的同时，减少对原系统的改造，而这个过程至少包含3个步骤：
    - 新增脱敏列的存储
    - 同时做数据迁移
    - 业务代码做兼容逻辑
- **痛点三**：迁移成本过大，需要开发团队密切测试每一张表，确保数据迁移完整
- **痛点四**：脱敏业务场景过多，开发团队需要平衡哪些场景下需要做脱敏，哪些场景下可不做

## 脱敏场景

1. #### 数据库脱敏（重点）

   Java 生态下的脱敏方案（[ShardingSphere](https://shardingsphere.apache.org/index_zh.html))

   引用 ShardingSphere 官方文档关于数据脱敏模块的说明：

   > 数据脱敏模块属于 ShardingSphere 分布式治理这一核心功能下的子功能模块。它通过对用户输入的 SQL 进行解析，并依据用户提供的脱敏配置对 SQL 进行改写，从而实现对原文数据进行加密，并将原文数据(可选)及密文数据同时存储到底层数据库。在用户查询数据时，它又从数据库中取出密文数据，并对其解密，最终将解密后的原始数据返回给用户。

2. #### 接口返回脱敏

   通常接口返回值中的一些敏感数据也是要脱敏的，比如身份证号、手机号码、地址.....通常的手段就是用`*`隐藏一部分数据，当然也可以根据自己需求定制（需求简单，实现较简单）

    1. 整合 Mybatis 插件，在查询的时候针对特定的字段进行脱敏
    2. 自定义 jackson 注解，在序列化时实现脱敏

3. #### 配置文件脱敏

   项目的配置文件中总有一些敏感信息，比如数据源的 url、用户名、密码....这些信息一旦被暴露那么整个数据库都将会被泄漏

   springboot 框架下的配置文件脱敏方案([jasypt-spring-boot](https://github.com/ulisesbocchio/jasypt-spring-boot))

4. #### 日志文件数据脱敏

   项目中总避免不了打印日志，肯定会涉及到一些敏感数据被明文打印出来，那么此时就需要过滤掉这些敏感数据（身份证、号码、用户名.....）

## 常见的脱敏算法

目前常见的脱敏算法包括 AES 加密、K 匿名、加星、屏蔽、洗牌、全保留、格式保留、令牌化等，算法及其主要用途介绍如下：

| 算法                                            | 主要用途                                                     |
| ----------------------------------------------- | ------------------------------------------------------------ |
| [K 匿名](https://zhuanlan.zhihu.com/p/50183231) | 通过如 K-匿名的算法对原始数据加入扰动和泛化，使得脱敏后的数据无法唯一对应回原数据，用于保留部分统计信息 |
| 加星                                            | 最基础的脱敏方法，保留字段一部分信息的同时通过加星遮蔽局部信息 |
| 屏蔽                                            | 用特殊字符如星号 * 作为掩码来将字段信息屏蔽掉                |
| 洗牌                                            | 将目标字段在样本中洗牌，使得脱敏后的信息无法唯一对应回原始样本，常用于脱敏后作为测试样例或保留部分统计信息 |
| 全保留                                          | 字段全保留，不脱敏，常用于字段无需脱敏的场景，如对主键不脱敏 |
| 格式保留                                        | 保留字段的原格式的前提下将其中一部分信息进行随机化，达到脱敏的同时仍然可以提供一部分该类型的信息，常用于脱敏后作为测试样例 |
| 令牌化                                          | 通过不可逆的算法将目标字段脱敏，但保留一份令牌使得可以在必要时还原 |
| AES 加密                                        | 一种对称加密算法，必要时可通过 AESKey 对脱敏结果进行还原     |

## 面临后果

一旦脱敏规则制定不好，系统性能会受到很大影响，系统性能降低，那么整个数据库业务系统也会随之受到影响，在数据连续性、高可用的环境下，可能会导致数据的丢失或者业务中断，影响整个生产过程。



